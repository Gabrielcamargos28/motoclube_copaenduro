@{
    ViewData["Title"] = "Inscritos - Copa Cerrado de Enduro";
    var etapas = ViewBag.Etapas as List<MotoClubeCerrado.Models.Etapa>;
}

<section class="section breadcrumb-section" style="background-image: url(/images/image-10-1920x232.jpg)">
    <div class="container">
        <h2 class="breadcrumb-section-title">Inscritos</h2>
        <div class="breadcrumb">
            <div class="breadcrumb-inner">
                <div class="breadcrumb-item"><a class="breadcrumb-link" href="/">Home</a></div>
                <div class="breadcrumb-item"><span>Inscritos</span></div>
            </div>
        </div>
    </div>
</section>

<section class="section-md bg-transparent">
    <div class="container">
        <div class="row row-30">
            <div class="col-md-12">
                <div class="box box-form-1">
                    <div class="box-form-header">
                        <div class="box-form-title h2">Inscritos - Copa Cerrado de Enduro</div>
                        <div class="box-form-text">
                            <p>
                                Para realizar o seu pagamento, favor realizar o Pix para a conta abaixo, lembrando que a identificação do piloto é feita através dos centavos, portanto deve ser feito o valor exato apresentado.
                                <br><strong>Alice Oliveira Seron</strong>
                                <br><strong>Pix (celular): 34992342393</strong>
                            </p>
                        </div>
                    </div>
                    <div class="box-form-body">
                        <div class="mb-3">
                            <label class="form-label" for="filtro-etapa"><strong>Filtrar por Etapa:</strong></label>
                            <select class="form-control" id="filtro-etapa" style="max-width: 400px;">
                                <option value="">Todas as etapas</option>
                                @if (etapas != null && etapas.Any())
                                {
                                    foreach (var etapa in etapas)
                                    {
                                        <option value="@etapa.Id">@etapa.Nome - @etapa.DataEvento?.ToString("dd/MM/yyyy")</option>
                                    }
                                }
                            </select>
                        </div>
                        <div class="table-responsive">
                            <table id="idTabelaInscritos" class="table table-hover text-nowrap">
                                <thead>
                                    <tr>
                                        <th>Nº Inscrição</th>
                                        <th>Etapa</th>
                                        <th>Categoria</th>
                                        <th>Nome</th>
                                        <th>Cidade</th>
                                        <th class="text-center">Valor</th>
                                        <th>Pagamento</th>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Styles {
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap4.min.css">
    <style>
        /* Estilização do select nativo */
        #filtro-etapa {
            appearance: auto;
            -webkit-appearance: menulist;
            -moz-appearance: menulist;
            background-color: white;
            border: 1px solid #ced4da;
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 4px;
            cursor: pointer;
        }

        #filtro-etapa:focus {
            outline: none;
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
    </style>
}

@section Scripts {
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap4.min.js"></script>
    <script>
        $(document).ready(function () {
            // Remover nice-select do filtro de etapa
            if ($('#filtro-etapa').next('.nice-select').length) {
                $('#filtro-etapa').next('.nice-select').remove();
                $('#filtro-etapa').show();
            }

            var table = $('#idTabelaInscritos').DataTable({
                "processing": true,
                "serverSide": false,
                "ajax": {
                    "url": "/Inscricao/PesquisaInscritos",
                    "type": "GET",
                    "data": function(d) {
                        var etapaId = $('#filtro-etapa').val();
                        if (etapaId && etapaId !== '') {
                            // Envia o ID da etapa selecionada
                            d.idEtapa = parseInt(etapaId);
                        } else {
                            // Quando vazio, envia 0 para indicar "Todas as etapas"
                            d.idEtapa = 0;
                        }
                    },
                    "dataSrc": "data"
                },
                "columns": [
                    {
                        "data": "numeroInscricao",
                        "render": function (data) {
                            return data ? '<strong>' + data + '</strong>' : '-';
                        }
                    },
                    { "data": "etapa" },
                    { "data": "categoria" },
                    { "data": "nome" },
                    { "data": "cidade" },
                    {
                        "data": "valor",
                        "className": "text-center",
                        "render": function (data, type, row) {
                            if (type === 'display') {
                                return parseFloat(data).toFixed(2);
                            }
                            return data;
                        }
                    },
                    {
                        "data": "pagamento",
                        "render": function (data, type, row) {
                            return data == 1 ? 'Confirmado' : 'Pendente';
                        }
                    }
                ],
                "order": [[0, "desc"], [1, "asc"], [2, "asc"]],
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.13.7/i18n/pt-BR.json"
                },
                "pageLength": 50,
                "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Todos"]]
            });

            // Recarregar tabela quando mudar o filtro de etapa
            $('#filtro-etapa').on('change', function() {
                console.log('Filtro de etapa mudado para:', $(this).val());
                table.ajax.reload();
            });

            // Atualizar a cada 30 segundos
            setInterval(function () {
                table.ajax.reload(null, false);
            }, 30000);
        });
    </script>
}
